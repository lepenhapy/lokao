<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Lok&aacute;o - Admin Piloto</title>
  <style>
    body { margin: 0; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #f4f6f8; color: #1f2937; }
    .wrap { max-width: 1100px; margin: 24px auto; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 10px 28px rgba(0,0,0,.08); }
    h1 { margin: 0 0 10px; color: #1f3c88; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 14px; }
    .kpi { border: 1px solid #dbeafe; background: #eff6ff; border-radius: 10px; padding: 10px; }
    .kpi strong { display: block; color: #1f3c88; margin-bottom: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
    th, td { border: 1px solid #e5e7eb; padding: 7px 8px; text-align: left; vertical-align: top; }
    th { background: #eef2ff; color: #1e3a8a; }
    .sec { margin-top: 18px; }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
      flex-wrap: wrap;
    }
    .badge {
      border: 1px solid #dbeafe;
      background: #eff6ff;
      color: #1f3c88;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
    }
    .links {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .links a {
      border: 1px solid #dbeafe;
      background: #eff6ff;
      color: #1f3c88;
      border-radius: 8px;
      padding: 6px 10px;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
    }
    .links a.active {
      background: #1f3c88;
      border-color: #1f3c88;
      color: #fff;
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Painel Admin do Piloto</h1>
      <span class="badge">Atualiza em <span id="countdown">60</span>s</span>
    </div>
    <div class="links">
      <a
        href="/piloto/admin?chave={{ chave }}"
        class="{% if not mostrar_todos %}active{% endif %}"
      >Recentes</a>
      <a
        href="/piloto/admin?chave={{ chave }}&todos=1"
        class="{% if mostrar_todos %}active{% endif %}"
      >Hist&oacute;rico completo</a>
      <a href="/piloto/admin/export/json?chave={{ chave }}">Exportar JSON</a>
      <a href="/piloto/admin/export/csv?chave={{ chave }}">Exportar CSV</a>
    </div>
    <div class="grid">
      <div class="kpi"><strong>Janela</strong>{{ painel.metricas.janela.inicio }} at&eacute; {{ painel.metricas.janela.fim }}</div>
      <div class="kpi"><strong>Gerados</strong>{{ painel.metricas.total_gerados }}</div>
      <div class="kpi"><strong>Feedbacks</strong>{{ painel.metricas.total_feedback }}</div>
      <div class="kpi"><strong>Taxa</strong>{{ painel.metricas.taxa_feedback_pct }}%</div>
    </div>

    <div class="sec">
      <h2>Feedbacks recentes</h2>
      <table>
        <tr>
          <th>Data</th>
          <th>Token</th>
          <th>Clareza</th>
          <th>Utilidade</th>
          <th>Confian&ccedil;a</th>
          <th>NPS</th>
          <th>Uso</th>
          <th>Etapa</th>
          <th>Faltante</th>
          <th>Aberto (resumo)</th>
        </tr>
        {% for item in painel.feedback %}
        <tr>
          <td>{{ item.ts }}</td>
          <td>{{ item.token }}</td>
          <td>{{ item.respostas.clareza }}</td>
          <td>{{ item.respostas.utilidade }}</td>
          <td>{{ item.respostas.confianca }}</td>
          <td>{{ item.respostas.nps }}</td>
          <td>{{ item.respostas.uso_relatorio }}</td>
          <td>{{ item.respostas.etapa_mais_util }}</td>
          <td>{{ item.respostas.info_faltante }}</td>
          <td>{{ item.respostas.valor_percebido }} | {{ item.respostas.faltou_algo }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>

    <div class="sec">
      <h2>Eventos recentes</h2>
      <table>
        <tr><th>Data</th><th>Tipo</th><th>Token</th></tr>
        {% for ev in painel.eventos %}
        <tr><td>{{ ev.ts }}</td><td>{{ ev.tipo }}</td><td>{{ ev.token }}</td></tr>
        {% endfor %}
      </table>
    </div>
  </div>
  <script>
    let seconds = 60;
    const el = document.getElementById("countdown");
    setInterval(() => {
      seconds -= 1;
      if (seconds <= 0) {
        window.location.reload();
        return;
      }
      if (el) {
        el.textContent = String(seconds);
      }
    }, 1000);
  </script>
</body>
</html>
